---

- block:
  - name: Check if the given old path for the moved password is present
    ansible.builtin.include_tasks: tests/secrets/tasks/check_passwordstore_password_present.yml
    vars:
      path: "{{ secrets_move_oldpath }}"

  - name: Check if the given new path for the moved password is absent 
    ansible.builtin.include_tasks: tests/secrets/tasks/check_passwordstore_password_absent.yml
    vars:
      path: "{{ secrets_move_newpath }}"
  rescue:
    - ansible.builtin.include_tasks: "{{ playbook_dir }}/tests/secrets/pre/cleanup.yml"
    - ansible.builtin.include_tasks: "{{ playbook_dir }}/tasks/secrets/cleanup.yml"
    - ansible.builtin.include_tasks: "{{ playbook_dir }}/tests/secrets/post/cleanup.yml"
    - ansible.builtin.fail:
        msg: "A previous rescued task failed"
