---

- block:
  - name: Check if the given commit exists
    ansible.builtin.include_tasks: tests/secrets/tasks/check_passwordstore_commit.yml
    vars:
      commit: "{{ secrets_revert_commit }}"
  rescue:
    - ansible.builtin.include_tasks: "{{ playbook_dir }}/tests/secrets/pre/cleanup.yml"
    - ansible.builtin.include_tasks: "{{ playbook_dir }}/tasks/secrets/cleanup.yml"
    - ansible.builtin.include_tasks: "{{ playbook_dir }}/tests/secrets/post/cleanup.yml"
    - ansible.builtin.fail:
        msg: "A previous rescued task failed"
