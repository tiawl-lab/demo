---

- ansible.builtin.set_fact:
    repo_passwordstore_dir: {}

- name: Create temporary directory
  ansible.builtin.tempfile:
    state: directory
  register: repo_passwordstore_dir

- name: Clone the password-store repository
  ansible.builtin.git:
    clone: true
    depth: 1
    repo: "{{ repo_passwordstore_url }}"
    dest: "{{ repo_passwordstore_dir.path }}"

- name: Compare the password-store .gpg-id with the GnuPG key id used to encrypt it
  ansible.builtin.fail:
    msg: "The password-store .gpg-id file must contains the GnuPG key used to encrypt it"
  when: fingerprint != lookup('ansible.builtin.file', repo_passwordstore_dir.path + "/.gpg-id")
