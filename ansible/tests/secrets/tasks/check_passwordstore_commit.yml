---

- ansible.builtin.set_fact:
    repo_passwordstore_dir: {}
    repo_passwordstore_commits: {}

- name: Create temporary directory
  ansible.builtin.tempfile:
    state: directory
  register: repo_passwordstore_dir

- name: Clone the password-store repository
  ansible.builtin.git:
    clone: true
    repo: "{{ repo_passwordstore_url }}"
    dest: "{{ repo_passwordstore_dir.path }}"

- name: Check if the commit exists in the password-store repository
  block:
  - ansible.builtin.command:
      cmd: git rev-list main
      chdir: "{{ repo_passwordstore_dir.path }}"
    register: repo_passwordstore_commits
  - ansible.builtin.fail:
      msg: "The long commit id {{ commit }} does not exists into the password-store git repository"
    when: commit not in repo_passwordstore_commits.stdout_lines
  when: commit | regex_search('^HEAD~[0-9]*$') == None
