---

- ansible.builtin.set_fact:
    org_gpg_public_key: {}
    org_gpg_private_key: {}

- block:
  - name: Check if the GnuPG key is an organization secret and register it
    block:
    - ansible.builtin.command: "{{ githoster_var_list_cmd + ' --org ' + repo_owner + ' --json name,value --jq \"
        if (any(.name == \\\"GPG_PUBLIC_KEY\\\") | not) then (
          halt_error(1)
        ) else (
          .[] | if (.name == \\\"GPG_PUBLIC_KEY\\\") then .value else empty end
        ) end\"' }}"
      register: org_gpg_public_key
    - ansible.builtin.command: "{{ githoster_var_list_cmd + ' --org ' + repo_owner + ' --json name,value --jq \"
        if (any(.name == \\\"GPG_PRIVATE_KEY\\\") | not) then (
          halt_error(1)
        ) else (
          .[] | if (.name == \\\"GPG_PRIVATE_KEY\\\") then .value else empty end
        ) end\"' }}"
      register: org_gpg_private_key
  environment:
    GH_TOKEN: "{{ secrets_token }}"

- name: Compare the GnuPG key with organization secrets
  block:
  - ansible.builtin.fail:
      msg: "GPG_PUBLIC_KEY organization secret and role input are not the same"
    when: org_gpg_public_key.stdout != gpg_public_key
  - ansible.builtin.fail:
      msg: "GPG_PRIVATE_KEY organization secret and role input are not the same"
    when: org_gpg_private_key.stdout != gpg_private_key
