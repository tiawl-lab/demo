---

- ansible.builtin.set_fact:
    gpg_keys: []
    gpg_listkeys_colonsfmt: {}

- name: Register GnuPG list keys output into a parseable format
  ansible.builtin.command: "{{ gpg_listkeys_cmd }}"
  register: gpg_listkeys_colonsfmt

- name: Register all GnuPG keys into an array
  ansible.builtin.set_fact:
    gpg_keys: "{{ gpg_keys + [item | regex_replace('^fpr:+([^:]+):$','\\1')] }}"
  when: item.startswith('fpr')
  loop: "{{ gpg_listkeys_colonsfmt.stdout_lines }}"

- name: Check if the given fingerprint is absent from the parsed list
  ansible.builtin.fail:
    msg: "The given GnuPG key must be absent locally"
  when: gpg_keys is defined and secrets_tests_gpgfingerprint in gpg_keys
