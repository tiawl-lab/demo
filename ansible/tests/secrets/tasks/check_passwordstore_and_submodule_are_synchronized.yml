---

- ansible.builtin.set_fact:
    repo_main_dir: {}
    repo_main_passwordstore_submodule_lastcommit: {}
    repo_passwordstore_dir: {}
    repo_passwordstore_lastcommit: {}

- name: Create temporary directories
  block:
  - ansible.builtin.tempfile:
      state: directory
    register: repo_passwordstore_dir
  - ansible.builtin.tempfile:
      state: directory
    register: repo_main_dir

- name: Clone both repositories
  block:
  - ansible.builtin.git:
      clone: true
      depth: 1
      repo: "{{ repo_passwordstore_url }}"
      dest: "{{ repo_passwordstore_dir.path }}"
  - ansible.builtin.git:
      clone: true
      depth: 1
      repo: "{{ repo_main_url }}"
      dest: "{{ repo_main_dir.path }}"
  - ansible.builtin.command:
      cmd: git checkout main
      chdir: "{{ repo_main_dir.path + '/' + repo_main_passwordstore_submodule_path }}"

- name: Register the last commits on both repositories
  block:
  - ansible.builtin.command:
      cmd: git rev-parse "HEAD:{{ repo_main_passwordstore_submodule_path }}"
      chdir: "{{ repo_main_dir.path }}"
    register: repo_main_passwordstore_submodule_lastcommit
  - ansible.builtin.command:
      cmd: git rev-parse HEAD
      chdir: "{{ repo_passwordstore_dir.path }}"
    register: repo_passwordstore_lastcommit

- name: Compare the last commits
  ansible.builtin.fail:
    msg: "The password-store submodule and the password-store repository are not synchronized"
  when: repo_main_passwordstore_submodule_lastcommit.stdout != repo_passwordstore_lastcommit.stdout
