---

# TODO: check the password-store repository has 1 more commit
# TODO: check the generated password has the specified length

- block:
  - name: Check the password-store repository and the password-store submodule are synchronized
    ansible.builtin.include_tasks: tests/secrets/tasks/check_passwordstore_and_submodule_are_synchronized.yml

  - name: Check if the last generated password was pushed
    block:
    - ansible.builtin.include_tasks: tests/secrets/tasks/check_passwordstore_password_present.yml
      vars:
        path: "{{ secrets_generate_path }}"
  rescue:
    - ansible.builtin.include_tasks: "{{ playbook_dir }}/tests/secrets/pre/cleanup.yml"
    - ansible.builtin.include_tasks: "{{ playbook_dir }}/tasks/secrets/cleanup.yml"
    - ansible.builtin.include_tasks: "{{ playbook_dir }}/tests/secrets/post/cleanup.yml"
    - ansible.builtin.fail:
        msg: "A previous rescued task failed"
- ansible.builtin.include_tasks: "{{ playbook_dir }}/tests/secrets/pre/cleanup.yml"
- ansible.builtin.include_tasks: "{{ playbook_dir }}/tasks/secrets/cleanup.yml"
- ansible.builtin.include_tasks: "{{ playbook_dir }}/tests/secrets/post/cleanup.yml"
