---

# TODO: check the password-store repository has 2 more commit
# TODO: check the password-store repository has 2 files .gpg-id and .gitattributes

- block:
  - name: Check if the password-store repository was created
    ansible.builtin.include_tasks: tests/secrets/tasks/check_passwordstore_repository.yml

  - name: Check if the password-store repository was encrypted with the imported key
    ansible.builtin.include_tasks: tests/secrets/tasks/check_passwordstore_gpgid.yml
    vars:
      fingerprint: "{{ secrets_setup_gpg_fingerprint_importedkey }}"

  - name: Check if the organization GnuPG key content
    ansible.builtin.include_tasks: tests/secrets/tasks/check_org_gpgkey.yml
    vars:
      gpg_public_key: "{{ secrets_setup_gpg_public_key }}"
      gpg_private_key: "{{ secrets_setup_gpg_private_key }}"

  - name: Check if the password-store submodule points to the password-store repository
    ansible.builtin.include_tasks: tests/secrets/tasks/check_submodule.yml

  - name: Check the password-store repository and the password-store submodule are synchronized
    ansible.builtin.include_tasks: tests/secrets/tasks/check_passwordstore_and_submodule_are_synchronized.yml
  rescue:
    - ansible.builtin.include_tasks: "{{ playbook_dir }}/tests/secrets/pre/cleanup.yml"
    - ansible.builtin.include_tasks: "{{ playbook_dir }}/tasks/secrets/cleanup.yml"
    - ansible.builtin.include_tasks: "{{ playbook_dir }}/tests/secrets/post/cleanup.yml"
    - ansible.builtin.fail:
        msg: "A previous rescued task failed"
